define(["config"],function(a){"use strict";var b,c=a.get("sulusecurity.permissions"),d="#matrix-container",e="#matrix",f="#role-form";return{name:"Sulu Security Role Form",layout:{},templates:["/admin/security/template/role/form"],initialize:function(){this.saved=!0,b=this.options.data.permissions,this.sandbox.on("husky.select.system.initialize",function(){this.initializeMatrices(this.sandbox.dom.data("#system","selection-values")[0]),this.initializeValidation(),this.bindDOMEvents(),this.bindCustomEvents(),this.setHeaderBar(!0),this.listenForChange()}.bind(this)),this.render()},bindDOMEvents:function(){this.sandbox.dom.on("#select-all","click",function(){this.sandbox.emit("husky.matrix.set-all")}.bind(this))},bindCustomEvents:function(){this.sandbox.on("husky.matrix.changed",function(a){this.changePermission(a)}.bind(this)),this.sandbox.on("sulu.toolbar.save",function(a){this.save(a)}.bind(this)),this.sandbox.on("sulu.toolbar.delete",function(){this.sandbox.emit("sulu.role.delete",this.sandbox.dom.val("#id"))}.bind(this)),this.sandbox.on("sulu.role.saved",function(a){this.options.data.id=a,this.setHeaderBar(!0)},this),this.sandbox.on("sulu.header.back",function(){this.sandbox.emit("sulu.roles.list")},this),this.sandbox.on("husky.select.system.selected.item",function(){this.initializeMatrices(this.sandbox.dom.data("#system","selection-values")[0])}.bind(this))},initializeValidation:function(){this.sandbox.form.create(f)},initializeMatrices:function(a){var b=this.sandbox.dom.createElement('<div id="matrix" class="loading"/>');this.sandbox.stop(e),this.sandbox.dom.append(d,b),this.sandbox.util.ajax({url:"/admin/contexts?system="+a}).done(function(a){for(var c in a)a.hasOwnProperty(c)&&this.initializeMatrix(c,a[c]);this.sandbox.dom.removeClass(b,"loading")}.bind(this))},initializeMatrix:function(a,d){var f,g,h=[],i=[],j=!1,k=[];for(var l in d)d.hasOwnProperty(l)&&(g=[],c.forEach(function(a){-1!==d[l].indexOf(a.value)&&g.push(a)}),k.push(g),h.push(l.split(".").splice(2).join(".")),b.forEach(function(a){a.context===l&&(j=!0,f=i.push([])-1,d[l].forEach(function(b){i[f].push(a.permissions[b])}))}),j||i.push([]));this.sandbox.start([{name:"matrix@husky",options:{el:e,captions:{general:a,type:this.sandbox.translate("security.roles.section"),horizontal:this.sandbox.translate("security.roles.permissions"),all:this.sandbox.translate("security.roles.all"),none:this.sandbox.translate("security.roles.none"),vertical:h},values:{vertical:Object.keys(d),horizontal:k},data:i}}])},changePermission:function(a){"string"==typeof a.value?this.setPermission(a.section,a.value,a.activated):this.sandbox.dom.each(a.value,function(b,c){this.setPermission(a.section,c.value,a.activated)}.bind(this)),a.activated||this.sandbox.dom.attr("#god",{checked:!1})},setPermission:function(a,c,d){var e=this.getContextKey(a);b[e]?b[e].permissions[c]=d:(b[e]={},b[e].context=a,b[e].permissions={},b[e].permissions[c]=d)},getContextKey:function(a){var c=b.length;return b.forEach(function(b,d){b.context===a&&(c=d)}),c},save:function(a){if(this.sandbox.form.validate(f)){var c={id:this.sandbox.dom.val("#id"),name:this.sandbox.dom.val("#name"),system:this.sandbox.dom.data("#system","selection-values")[0],permissions:b};this.options.data=this.sandbox.util.extend(!0,{},this.options.data,c),this.sandbox.emit("sulu.roles.save",c,a)}},render:function(){this.$el.html(this.renderTemplate("/admin/security/template/role/form",{data:this.options.data})),this.sandbox.start(this.$el)},setHeaderBar:function(a){a!==this.saved&&(a?this.sandbox.emit("sulu.header.toolbar.item.disable","save",!0):this.sandbox.emit("sulu.header.toolbar.item.enable","save",!1)),this.saved=a},listenForChange:function(){this.sandbox.dom.on("#role-form","change",function(){this.setHeaderBar(!1)}.bind(this),"select, input"),this.sandbox.dom.on("#role-form","keyup",function(){this.setHeaderBar(!1)}.bind(this),"input"),this.sandbox.on("husky.matrix.changed",function(){this.setHeaderBar(!1)}.bind(this)),this.sandbox.on("husky.select.system.selected.item",function(a){this.setHeaderBar(!1)}.bind(this)),this.sandbox.on("husky.select.security-type.selected.item",function(a){this.setHeaderBar(!1)}.bind(this))}}});