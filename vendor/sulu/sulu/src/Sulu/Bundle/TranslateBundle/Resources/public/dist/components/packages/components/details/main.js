define([],function(){"use strict";return function(){var a,b="#codes-form";return{layout:{},templates:["/admin/translate/template/translation/form"],initialize:function(){this.saved=!0,this.codesToDelete=[],this.codesCounter=1,this.render(),this.setHeaderBar(!0),this.listenForChange()},render:function(){this.$el.html(this.renderTemplate("/admin/translate/template/translation/form",{packageName:this.options.data.name})),a=this.$el.find("#codes .code-item:first"),a.remove(),this.initSelectCatalogues(),this.initVisibilityOptions(),this.initData(),this.sandbox.form.create(b),this.bindDomEvents(),this.bindCustomEvents()},bindDomEvents:function(){this.sandbox.dom.on("#code-add","click",this.addCode.bind(this)),this.sandbox.dom.on("#codes","click",this.removeCode.bind(this),".code-remove"),this.sandbox.dom.on(b,"click",function(a){this.sandbox.dom.$(a.currentTarget).prop("readonly",!1)}.bind(this),".form-element[readonly]"),this.sandbox.dom.on("#codes-form","keyup change",function(a){var b=a.currentTarget,c=b.scrollHeight,d=b.clientHeight;c>d&&(b.style.height=c+5+"px")}.bind(this),"textarea"),this.sandbox.dom.on("#codes","change",function(a){var c=this.sandbox.dom.$(a.currentTarget),d=c.parent().parent().parent().parent().parent(),e=this.sandbox.dom.find(".translation-value",d),f=this.sandbox.dom.find(".length-info",d),g=parseInt(c.val(),10);this.sandbox.form.updateConstraint(b,e,"maxLength",{maxLength:g}),this.sandbox.dom.html(f,g)}.bind(this),".length-value"),this.sandbox.on("husky.select.catalogues.selected.item",function(a){this.sandbox.emit("sulu.translate.catalogue.changed",this.options.data.id,a)},this),this.sandbox.dom.keypress(b,function(a){13===a.which&&(a.preventDefault(),this.submit())}.bind(this))},bindCustomEvents:function(){this.sandbox.on("sulu.header.toolbar.delete",function(){this.sandbox.emit("sulu.translate.package.delete",this.options.data.id)},this),this.sandbox.on("sulu.header.toolbar.save",function(){this.submit()},this),this.sandbox.on("sulu.translate.translations.saved",function(){this.setTabs(),this.setHeaderBar(!0)},this),this.sandbox.on("sulu.header.back",function(){this.sandbox.emit("sulu.translate.package.list")},this)},initData:function(){this.sandbox.dom.each(this.options.translations,function(b,c){var d=a.clone(),e=this.sandbox.dom.find(".code-value",d),f=this.sandbox.dom.find(".translation-value",d),g=this.sandbox.dom.find(".length-value",d),h=this.sandbox.dom.find(".length-info",d),i=this.sandbox.dom.find(".frontend-value",d),j=this.sandbox.dom.find(".backend-value",d),k=this.sandbox.dom.find(".suggestion-value",d);this.sandbox.dom.data(d,"id",c.id),this.sandbox.dom.val(e,c.code.code),this.sandbox.dom.val(f,c.value),this.sandbox.dom.val(g,c.code.length),this.sandbox.dom.prop(i,"checked",c.code.frontend),this.sandbox.dom.prop(j,"checked",c.code.backend),this.sandbox.dom.html(h,c.code.length),this.sandbox.dom.html(k,c.suggestion),this.sandbox.dom.data(f,"validationMaxLength",c.code.length),this.sandbox.dom.append("#codes",d)}.bind(this))},initSelectCatalogues:function(){this.sandbox.start([{name:"select@husky",options:{el:this.sandbox.dom.$("#languageCatalogue"),valueName:"locale",instanceName:"catalogues",preSelectedElements:[this.options.selectedCatalogue.id],data:this.options.data.catalogues}}])},initVisibilityOptions:function(){this.sandbox.dom.on("#codes","click",function(a){var b=this.sandbox.dom.$(a.currentTarget),c=this.sandbox.dom.next(this.sandbox.dom.parent(this.sandbox.dom.parent(b)),".additional-options");this.sandbox.dom.toggleClass(b,"custom-icon-arrow-right"),this.sandbox.dom.toggleClass(b,"custom-icon-arrow-down"),this.sandbox.dom.toggleClass(c,"hidden")}.bind(this),".show-options")},fillFields:function(a,b,c){for(;a.length<b;)a.push(c)},submit:function(){if(this.sandbox.form.validate(b)){var a,c,d,e,f,g,h,i,j,k={},l=this.sandbox.dom.find("#codes .code-item");k=[],this.sandbox.dom.each(l,function(b,l){c=this.sandbox.dom.data(l,"id"),e=this.sandbox.dom.$(l),f=this.sandbox.dom.find(".code-value",e),g=this.sandbox.dom.find(".translation-value",e),h=this.sandbox.dom.find(".length-value",e),i=this.sandbox.dom.find(".frontend-value",e),j=this.sandbox.dom.find(".backend-value",e),d=this.search(c),a={id:c,value:this.sandbox.dom.val(g),code:{code:this.sandbox.dom.val(f),length:this.sandbox.dom.val(h),frontend:this.sandbox.dom.prop(i,"checked"),backend:this.sandbox.dom.prop(j,"checked")}},(d||d.value!==a.value||d.code.code!==a.code.code||d.code.length!==a.code.length||d.code.backend!==a.code.backend||d.code.frontend!==a.code.frontend)&&k.push(a)}.bind(this)),this.sandbox.emit("sulu.translate.translations.save",k,this.codesToDelete),this.codesToDelete=[]}},search:function(a){var b=!1;return this.sandbox.dom.each(this.translations,function(c,d){return d.id===a?(b=d,!1):!0}.bind(this)),b},addCode:function(){var c=a.clone(),d=this.sandbox.dom.find(".additional-options",c),e=this.sandbox.dom.find(".code-value",c),f=this.sandbox.dom.find(".translation-value",c),g=this.sandbox.dom.find(".length-value",c),h=this.sandbox.dom.find(".frontend-value",c),i=this.sandbox.dom.find(".backend-value",c),j=this.sandbox.dom.find(".show-options",c);this.sandbox.dom.attr(this.sandbox.dom.prev(g,"label"),{"for":"length-"+this.codesCounter.toString()}),this.sandbox.dom.attr(g,{id:"length-"+this.codesCounter.toString()}),this.sandbox.dom.attr(this.sandbox.dom.parent(h),{"for":"frontent-"+this.codesCounter.toString()}),this.sandbox.dom.attr(h,{id:"frontent-"+this.codesCounter.toString()}),this.sandbox.dom.attr(this.sandbox.dom.parent(i),{"for":"backend-"+this.codesCounter.toString()}),this.sandbox.dom.attr(i,{id:"backend-"+this.codesCounter.toString()}),this.sandbox.dom.toggleClass(j,"custom-icon-arrow-right"),this.sandbox.dom.toggleClass(j,"custom-icon-arrow-down"),this.sandbox.dom.append("#codes",c),this.sandbox.dom.removeClass(d,"hidden"),this.sandbox.dom.$(e).prop("readonly",!1),this.sandbox.dom.$(f).prop("readonly",!1),$(window).scrollTop(c.offset().top),this.sandbox.form.addField(b,e),this.sandbox.form.addField(b,f),this.sandbox.form.addField(b,g),this.sandbox.form.addField(b,h),this.sandbox.form.addField(b,i),this.codesCounter++},removeCode:function(a){var c=$(a.target).parent().parent().parent(),d=this.sandbox.dom.find(".code-value",c),e=this.sandbox.dom.find(".translation-value",c),f=this.sandbox.dom.find(".length-value",c),g=this.sandbox.dom.find(".frontend-value",c),h=this.sandbox.dom.find(".backend-value",c);this.sandbox.dom.data(c,"id")&&this.codesToDelete.push(this.sandbox.dom.data(c,"id")),this.sandbox.form.removeField(b,d),this.sandbox.form.removeField(b,e),this.sandbox.form.removeField(b,f),this.sandbox.form.removeField(b,g),this.sandbox.form.removeField(b,h),this.setHeaderBar(!1),c.remove()},setHeaderBar:function(a){if(a!==this.saved){var b=this.options.data&&this.options.data.id?"edit":"add";this.sandbox.emit("sulu.header.toolbar.state.change",b,a)}this.saved=a},listenForChange:function(){this.sandbox.dom.on(b,"change",function(){this.setHeaderBar(!1)}.bind(this),"select, input, textarea"),this.sandbox.dom.on(b,"keyup",function(){this.setHeaderBar(!1)}.bind(this),"input, textarea")}}}()});